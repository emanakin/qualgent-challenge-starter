# QualGent Challenge — Android Automation Agent

A production-ready Android automation testing framework with scaling, observability, and reliability features.

## Quick Start

```bash
# 1) Create device pool
./infra/create_devices.sh

# 2) Run evaluation episodes
./evaluate.sh 10 "search for android automation"

# 3) View results
open results/run_*.html  # Rich HTML report
cat results/report.md    # Markdown summary
cat observability/trace_run_*.jsonl  # Detailed traces

# 4) Cleanup
./infra/cleanup.sh
```

## Detailed Operations Runbook

### Prerequisites Setup

```bash
# 1) Install required tools (WSL/Linux)
sudo apt-get update
sudo apt-get install -y adb python3 python3-pip docker.io

# 2) Install Genymotion SaaS CLI
# Download from: https://docs.genymotion.com/saas/tools/gmsaas/
# Or install via package manager

# 3) Configure Genymotion authentication
gmsaas auth token YOUR_API_TOKEN_HERE
gmsaas config set android-sdk-path /path/to/android-sdk
gmsaas config set output-format json

# 4) Verify setup
gmsaas instances list
adb version
python3 --version
```

### Environment Variables Configuration

```bash
# Core device connection variables (auto-generated by create_devices.sh)
export ADB_HOSTPORT="localhost:45763"     # Device ADB tunnel address
export ANDROID_SERIAL="localhost:45763"  # Same as ADB_HOSTPORT for compatibility

# Genymotion API configuration
export GENYMOTION_API_TOKEN="your-token-here"
export GM_TEMPLATE="53d71621-b0b8-4e5a-8cea-0055ea98988f"  # Pixel 6 template

# Device pool sizing
export NB_DEVICES="3"                     # Number of devices to create
export NAME_PREFIX="qualgent-emu"         # Device naming prefix

# Observability configuration
export TRACE_DIR="observability"          # Trace output directory
export GOOGLE_CLOUD_PROJECT="your-project"  # For GCP trace export (optional)

# Testing modes
export MOCK_ADB="1"                       # Enable mock mode for CI testing
export RETRIES="1"                        # Retry attempts for flaky operations

# Timeouts and performance
export POLL_TIMEOUT_SEC="300"            # Device startup timeout
export POLL_INTERVAL_SEC="5"             # Status check interval

# Load testing configuration
export CONCURRENCY="3"                   # Concurrent workers for load tests
export EPISODES="10"                     # Episodes per worker
```

### Device Pool Management

#### Creating Single Device

```bash
# Basic single device creation
./infra/create_devices.sh

# Verify device creation
cat infra/instances.txt        # Shows device UUID
cat infra/adb_tunnels.txt      # Shows ADB connection info
cat infra/env.sh              # Shows generated environment variables

# Source the environment
source infra/env.sh
echo "Connected to: $ANDROID_SERIAL"
```

#### Creating Multiple Devices

```bash
# Create devices with custom names
NAME_PREFIX="loadtest-$(date +%s)" NB_DEVICES=3 ./infra/create_devices.sh

# Verify all devices
cat infra/adb_tunnels.txt
# Expected output:
# uuid1 localhost:45763
# uuid2 localhost:45764
# uuid3 localhost:45765
```

#### Device Pool Status Monitoring

```bash
# Check Genymotion device status
gmsaas instances list | jq '.instances[] | {name, state, adb_serial}'

# Check ADB connectivity to all devices
while read uuid hostport; do
  echo "Testing $hostport..."
  adb connect "$hostport" && adb -s "$hostport" get-state
done < infra/adb_tunnels.txt

# Health check all devices
for device in $(awk '{print $2}' infra/adb_tunnels.txt); do
  export ANDROID_SERIAL="$device"
  ./healthcheck.sh && echo "$device: OK" || echo "$device: FAILED"
done
```

#### Device Pool Scaling

```bash
# Scale device pool to specific size
./infra/device_pool_manager.sh 5   # Ensure exactly 5 devices

# Scale up gradually
./infra/device_pool_manager.sh 3   # Start with 3
sleep 30
./infra/device_pool_manager.sh 5   # Scale to 5
sleep 30
./infra/device_pool_manager.sh 2   # Scale down to 2

# Monitor scaling operations
watch -n 5 'gmsaas instances list | grep -c ONLINE'
```

### Running Evaluations

#### Basic Evaluation Runs

```bash
# Single evaluation with default settings
./evaluate.sh 5 "search for android automation"

# Multiple task types
./evaluate.sh 3 "open settings"
./evaluate.sh 3 "tap 500 600"
./evaluate.sh 3 "scroll down 3 times"
./evaluate.sh 3 "open url https://google.com"

# With custom retry settings
RETRIES=2 ./evaluate.sh 5 "search for flaky test"
```

#### Batch Evaluation Runs

```bash
# Run multiple evaluations in sequence
for task in "search for AI" "open settings" "wifi on" "screenshot"; do
  echo "Running task: $task"
  ./evaluate.sh 3 "$task"
  sleep 5
done

# Parallel evaluation on different devices (if multiple available)
device1=$(awk 'NR==1{print $2}' infra/adb_tunnels.txt)
device2=$(awk 'NR==2{print $2}' infra/adb_tunnels.txt)

ANDROID_SERIAL="$device1" ./evaluate.sh 5 "search for test1" &
ANDROID_SERIAL="$device2" ./evaluate.sh 5 "search for test2" &
wait

echo "Both evaluations completed"
```

#### CI/Mock Mode Testing

```bash
# Test without real devices (CI mode)
export MOCK_ADB=1
./evaluate.sh 3 "search for ci test"

# Verify mock mode worked
grep "mocked_output" results/run_*.json || echo "Mock mode may not be working"

# Reset to real mode
unset MOCK_ADB
./evaluate.sh 1 "search for real test"
```

### Docker Operations

#### Building and Running Containers

```bash
# Build the container image
docker build -t candidate/android-world .

# Tag for different environments
docker tag candidate/android-world:latest candidate/android-world:dev
docker tag candidate/android-world:latest candidate/android-world:$(git rev-parse --short HEAD)

# Run with real device connection
source infra/env.sh
docker run --rm --net=host \
  -e ANDROID_SERIAL="$ANDROID_SERIAL" \
  -e GENYMOTION_API_TOKEN="$GENYMOTION_API_TOKEN" \
  -v "$PWD/results:/workspace/results" \
  -v "$PWD/observability:/workspace/observability" \
  candidate/android-world

# Run specific evaluation in container
docker run --rm --net=host \
  -e ANDROID_SERIAL="$ANDROID_SERIAL" \
  -v "$PWD/results:/workspace/results" \
  candidate/android-world \
  bash -c "./evaluate.sh 5 'search for containerized test'"

# Run in mock mode (for CI)
docker run --rm -e MOCK_ADB=1 \
  -v "$PWD/results:/workspace/results" \
  candidate/android-world \
  bash -c "./evaluate.sh 3 'search for docker ci test'"
```

#### Container Debugging

```bash
# Interactive container session
docker run -it --rm --net=host \
  -e ANDROID_SERIAL="$ANDROID_SERIAL" \
  -v "$PWD:/workspace" \
  candidate/android-world bash

# Check container health
docker run --rm candidate/android-world ./healthcheck.sh

# View container logs
docker logs $(docker ps -q --filter ancestor=candidate/android-world)
```

### Load Testing Operations

#### Basic Load Testing

```bash
# Ensure sufficient devices first
NB_DEVICES=3 ./infra/create_devices.sh

# Run load test: 3 workers × 5 episodes each
./loadtest/run.sh 5 3 "search for load test"

# Custom load test parameters
EPISODES=10 CONCURRENCY=2 ./loadtest/run.sh

# Monitor load test progress
tail -f results/load_test_*.json
```

#### Advanced Load Testing

```bash
# Stress test with maximum concurrency
MAX_DEVICES=$(wc -l < infra/adb_tunnels.txt)
./loadtest/run.sh 20 $MAX_DEVICES "search for stress test"

# Endurance testing
for i in {1..5}; do
  echo "Endurance run $i/5"
  ./loadtest/run.sh 10 2 "endurance test run $i"
  sleep 60  # Cool down between runs
done

# Load test different task types
for task in "search for test" "open settings" "scroll down" "tap 500 600"; do
  echo "Load testing: $task"
  ./loadtest/run.sh 5 2 "$task"
  sleep 30
done
```

#### Load Test Analysis

```bash
# View latest load test results
cat results/load_report.md

# Analyze success rates across runs
grep -h "success_rate" results/load_test_*.json | \
  jq -r '.summary.success_rate' | \
  awk '{sum+=$1; count++} END {print "Average success rate:", sum/count}'

# Find bottlenecks
jq -r '.worker_results[] | select(.success==false) | .stderr_tail' \
  results/load_test_*.json | sort | uniq -c | sort -nr

# Performance trends
ls -t results/load_test_*.json | head -5 | xargs -I {} \
  jq -r '{file: "{}", episodes_per_sec: .summary.episodes_per_second}' {}
```

### Observability and Debugging

#### Trace Analysis

```bash
# View trace correlation
latest_run=$(ls -t results/run_*.json | head -1)
run_id=$(basename "$latest_run" .json)
trace_id=$(jq -r '.[0].trace_id' "$latest_run")

echo "Run ID: $run_id"
echo "Trace ID: $trace_id"
echo "Trace file: observability/trace_${run_id}.jsonl"

# Analyze trace timing
jq -r 'select(.span=="task.execute") | .dur_ms' \
  observability/trace_${run_id}.jsonl | \
  awk '{sum+=$1; count++} END {print "Avg task duration:", sum/count, "ms"}'

# Find slow operations
jq -r 'select(.dur_ms > 1000) | {span, dur_ms, attrs}' \
  observability/trace_*.jsonl | head -10

# Export traces to GCP (if configured)
if [ -n "$GOOGLE_CLOUD_PROJECT" ]; then
  python3 -c "
from observability.trace import export_to_gcp_trace
import glob
for trace_file in glob.glob('observability/trace_*.jsonl'):
    export_to_gcp_trace(trace_file, '$GOOGLE_CLOUD_PROJECT')
"
fi
```

#### Health Monitoring

```bash
# Monitor device health continuously
watch -n 10 '
echo "=== Device Health Status ==="
while read uuid hostport; do
  status=$(timeout 5 adb -s "$hostport" get-state 2>/dev/null || echo "FAILED")
  echo "$hostport: $status"
done < infra/adb_tunnels.txt
'

# Check for common issues
echo "=== Troubleshooting Checklist ==="
echo "1. ADB Server Status:"
adb version && echo "✓ ADB installed" || echo "✗ ADB missing"

echo "2. Genymotion API Status:"
gmsaas instances list >/dev/null 2>&1 && echo "✓ Genymotion API working" || echo "✗ API issues"

echo "3. Device Connectivity:"
device_count=$(wc -l < infra/adb_tunnels.txt 2>/dev/null || echo "0")
echo "Available devices: $device_count"

echo "4. Results Directory:"
ls -la results/ | tail -5
```

### Cleanup and Maintenance

#### Complete Cleanup

```bash
# Clean up all resources
./infra/cleanup.sh

# Verify cleanup
gmsaas instances list | jq '.instances | length'  # Should be 0
cat infra/instances.txt    # Should be empty
cat infra/adb_tunnels.txt  # Should be empty

# Clean up old results (keep last 10)
ls -t results/run_*.json | tail -n +11 | xargs rm -f
ls -t observability/trace_*.jsonl | tail -n +11 | xargs rm -f
```

#### Maintenance Tasks

```bash
# Archive old results
mkdir -p archive/$(date +%Y%m%d)
mv results/run_*.json results/run_*.csv results/run_*.html archive/$(date +%Y%m%d)/ 2>/dev/null || true
mv observability/trace_*.jsonl archive/$(date +%Y%m%d)/ 2>/dev/null || true

# Clean Docker images
docker system prune -f
docker image prune -f

# Reset environment
unset MOCK_ADB ANDROID_SERIAL ADB_HOSTPORT
rm -f infra/env.sh

# Restart fresh
./infra/create_devices.sh
source infra/env.sh
```

### Troubleshooting Common Issues

#### Device Connection Issues

```bash
# Reset ADB server
adb kill-server && adb start-server

# Reconnect to all devices
while read uuid hostport; do
  echo "Reconnecting to $hostport..."
  adb connect "$hostport"
done < infra/adb_tunnels.txt

# Test device responsiveness
export ANDROID_SERIAL=$(awk 'NR==1{print $2}' infra/adb_tunnels.txt)
adb shell echo "Device responsive" || echo "Device unresponsive"
```

#### Performance Issues

```bash
# Check system resources
echo "=== System Resources ==="
free -h
df -h .
docker system df

# Monitor during execution
./evaluate.sh 5 "search for performance test" &
eval_pid=$!

while kill -0 $eval_pid 2>/dev/null; do
  echo "$(date): CPU=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}'), Memory=$(free | grep Mem | awk '{printf "%.1f%%", $3/$2 * 100.0}')"
  sleep 5
done
```

#### Failed Evaluations

```bash
# Analyze failure patterns
failed_runs=$(jq -r 'select(.[].success==false) | input_filename' results/run_*.json)
echo "Failed runs: $failed_runs"

# Check error details
jq -r '.[] | select(.success==false) | {episode, task, details}' results/run_*.json

# Retry failed tasks
last_failed_task=$(jq -r '.[] | select(.success==false) | .task' results/run_*.json | tail -1)
if [ -n "$last_failed_task" ]; then
  echo "Retrying failed task: $last_failed_task"
  RETRIES=3 ./evaluate.sh 1 "retry $last_failed_task"
fi
```

## Supported Task Prompts

| Category            | Examples                                                             |
| ------------------- | -------------------------------------------------------------------- |
| **Search & Browse** | "search for android automation", "open url https://example.com"      |
| **Navigation**      | "open settings", "open app com.package/.Activity", "go home", "back" |
| **Interaction**     | "tap 500 600", "swipe 500 1600 500 600", "scroll down 3 times"       |
| **Input**           | "type hello world"                                                   |
| **System**          | "wifi on/off", "notifications", "screenshot"                         |

## Observability & Tracing

### Correlation Flow

```
Run ID (run_1234567) ←→ Trace ID (abc123def) ←→ Episodes
├── results/run_1234567.json    # Episode results
├── results/run_1234567.csv     # Tabular data
├── results/run_1234567.html    # Rich report
└── observability/trace_run_1234567.jsonl  # Detailed spans
```

### Trace Structure

```json
{
  "trace_id": "abc123def",
  "run_id": "run_1234567",
  "span": "task.execute",
  "dur_ms": 2340.5,
  "attrs": { "episode": 3, "task": "browser_search" },
  "status": "OK"
}
```

### Google Cloud Integration (Optional)

```bash
export GOOGLE_CLOUD_PROJECT=your-project
export GOOGLE_APPLICATION_CREDENTIALS=path/to/service-account.json
# Traces and logs automatically export to Cloud Logging/Trace
```

## Scaling & Production

### Kubernetes Deployment

```bash
# Deploy runner pods with HPA
kubectl apply -f k8s/secrets.yaml
kubectl apply -f k8s/runner-deployment.yaml
kubectl apply -f k8s/runner-hpa.yaml

# Deploy device pool manager
kubectl apply -f k8s/device-pool-cronjob.yaml

# Scale based on load
kubectl patch hpa android-world-runner-hpa --patch '{"spec":{"maxReplicas":20}}'
```

### Load Testing

```bash
# Test with 3 concurrent workers, 10 episodes each
./loadtest/run.sh 10 3 "search for load test"

# View load test results
cat results/load_report.md
open results/load_test_*.json
```

### Reliability Features

- **Timeouts**: All ADB commands have 5-15s timeouts
- **Health Checks**: Pre-flight ADB connectivity validation
- **Retries**: Automatic retry with flakiness detection
- **Circuit Breaker**: Stops execution if device becomes unresponsive

## CI/CD Pipeline

### GitHub Actions

```bash
# Offline smoke test (always runs)
git push origin main  # Triggers build + test + push

# Online smoke test (optional, requires secrets)
# Set repository variables:
# - ENABLE_ONLINE_SMOKE=true
# - GM_TEMPLATE=53d71621-b0b8-4e5a-8cea-0055ea98988f
# Set repository secrets:
# - GENYMOTION_API_TOKEN=your-token
```

### Local CI Simulation

```bash
# Run offline smoke test
export MOCK_ADB=1
./evaluate.sh 2 "search for ci test"

# Verify no real ADB calls were made
grep "mocked_output" results/run_*.json
```

## Development

### Project Structure

```
├── agents/              # Agent logic & task execution
│   ├── runner.py       # Main evaluation runner with tracing
│   ├── executor.py     # Task executors with timeouts/health checks
│   ├── harness.py      # Episode management & retry logic
│   └── prompt_to_task.py # Natural language → task mapping
├── infra/              # Device pool management
│   ├── create_devices.sh    # Provision Genymotion devices
│   ├── cleanup.sh           # Cleanup device pool
│   └── device_pool_manager.sh # Auto-scaling device pool
├── observability/      # Tracing & monitoring
│   └── trace.py        # JSONL tracer with GCP export
├── loadtest/           # Load & resilience testing
│   ├── stress.py       # Concurrent worker load test
│   └── run.sh          # Load test runner
├── k8s/                # Kubernetes manifests
│   ├── runner-deployment.yaml # Worker pods
│   ├── runner-hpa.yaml        # Horizontal Pod Autoscaler
│   └── device-pool-cronjob.yaml # Device pool manager
└── .github/workflows/  # CI/CD pipeline
    └── ci.yml          # Build, test, push, smoke test
```

### Environment Variables

```bash
# Device connection
ANDROID_SERIAL=localhost:5555    # ADB device target
ADB_HOSTPORT=localhost:5555      # Same as ANDROID_SERIAL

# Genymotion API
GENYMOTION_API_TOKEN=your-token  # API authentication
GM_TEMPLATE=53d71621-...         # Pixel 6 template UUID

# Observability
TRACE_DIR=observability          # Trace output directory
GOOGLE_CLOUD_PROJECT=your-proj   # GCP project for exports

# Testing
MOCK_ADB=1                       # Enable mock mode for CI
```

## Troubleshooting

### Common Issues

```bash
# Device not connecting
adb kill-server && adb start-server
source infra/env.sh && adb connect "$ADB_HOSTPORT"

# Trace files not generated
export TRACE_DIR=observability
mkdir -p observability

# Load test failing
./infra/create_devices.sh  # Ensure enough devices
cat infra/adb_tunnels.txt  # Verify device list

# Health check failing
./healthcheck.sh  # Test ADB connectivity
```
